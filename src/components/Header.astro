---
import Button from './ui/Button.astro';
import { getLangFromUrl, useTranslations, type Lang } from '../i18n';

interface Props {
  lang?: Lang;
}

const { lang: propLang } = Astro.props;
const lang = propLang || getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface NavItem {
  label: string;
  href: string;
  active?: boolean;
}

const langPrefix = lang === 'uz' ? '' : `/${lang}`;

const navItems: NavItem[] = [
  { label: t('nav.home'), href: `${langPrefix}/`, active: true },
  { label: t('nav.projects'), href: `${langPrefix}/#projects` },
  { label: t('nav.clients'), href: `${langPrefix}/#clients` },
  { label: t('nav.services'), href: `${langPrefix}/#services` },
  { label: t('nav.contact'), href: `${langPrefix}/#contact` },
];

const phone = '+998 55-203-71-71';

// Language data for switcher
const languages = [
  { code: 'uz', name: t('language.uz'), flag: `<svg width="24" height="16" viewBox="0 0 24 16" fill="none" class="rounded-sm"><rect width="24" height="5.33" fill="#0099B5"/><rect y="5.33" width="24" height="0.67" fill="#CE1126"/><rect y="6" width="24" height="4" fill="white"/><rect y="10" width="24" height="0.67" fill="#CE1126"/><rect y="10.67" width="24" height="5.33" fill="#1EB53A"/><circle cx="5" cy="2.67" r="1.5" fill="white"/><circle cx="5.5" cy="2.67" r="1" fill="#0099B5"/></svg>` },
  { code: 'ru', name: t('language.ru'), flag: `<svg width="24" height="16" viewBox="0 0 24 16" fill="none" class="rounded-sm"><rect width="24" height="5.33" fill="white"/><rect y="5.33" width="24" height="5.33" fill="#0039A6"/><rect y="10.67" width="24" height="5.33" fill="#D52B1E"/></svg>` },
  { code: 'en', name: t('language.en'), flag: `<svg width="24" height="16" viewBox="0 0 24 16" fill="none" class="rounded-sm"><rect width="24" height="16" fill="#012169"/><path d="M0 0L24 16M24 0L0 16" stroke="white" stroke-width="2.5"/><path d="M0 0L24 16M24 0L0 16" stroke="#C8102E" stroke-width="1.5"/><path d="M12 0V16M0 8H24" stroke="white" stroke-width="4"/><path d="M12 0V16M0 8H24" stroke="#C8102E" stroke-width="2.5"/></svg>` },
];

const currentLang = languages.find(l => l.code === lang) || languages[0];

// Get current path without language prefix for switching
const pathname = Astro.url.pathname;
const pathWithoutLang = pathname.replace(/^\/(uz|ru|en)/, '') || '/';
---

<header class="fixed top-0 left-0 right-0 z-[200] bg-white/95 backdrop-blur-sm border-b border-transparent hover:border-bf-gray-light transition-colors duration-300">
  <div class="container-bf h-header flex items-center justify-between">

    <!-- Logo -->
    <a href={`${langPrefix}/`} class="flex-shrink-0 group" aria-label="Bright Future - {t('nav.home')}">
      <img src="/logo.svg" alt="Bright Future" class="h-8 w-auto transition-transform duration-300 group-hover:scale-105" />
    </a>

    <!-- Navigation - Desktop -->
    <nav class="hidden lg:flex items-center gap-8" aria-label="Main navigation">
      {navItems.map((item) => (
        <a
          href={item.href}
          class:list={[
            'text-nav font-medium transition-colors duration-200 relative',
            'after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5',
            'after:bg-bf-primary after:transition-all after:duration-300',
            'hover:after:w-full',
            item.active ? 'text-bf-primary' : 'text-bf-black hover:text-bf-primary',
          ]}
        >
          {item.label}
        </a>
      ))}
    </nav>

    <!-- Right Section -->
    <div class="hidden md:flex items-center gap-6">

      <!-- Language Switcher -->
      <div class="lang-switcher relative">
        <button class="lang-btn flex items-center gap-2 cursor-pointer group" id="lang-btn">
          <span class="lang-flag" id="current-flag" set:html={currentLang.flag} />
          <span class="text-nav font-medium text-bf-black group-hover:text-bf-primary transition-colors duration-200" id="current-lang">{currentLang.name}</span>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="text-bf-gray group-hover:text-bf-primary transition-all duration-200" id="lang-chevron">
            <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <!-- Dropdown -->
        <div class="lang-dropdown" id="lang-dropdown">
          {languages.map((language) => (
            <a
              href={language.code === 'uz' ? pathWithoutLang : `/${language.code}${pathWithoutLang}`}
              class:list={['lang-option', language.code === lang && 'active']}
              data-lang={language.code}
            >
              <span set:html={language.flag} />
              <span>{language.name}</span>
            </a>
          ))}
        </div>
      </div>

      <!-- Phone -->
      <a href={`tel:${phone.replace(/\s/g, '')}`} class="text-nav font-medium text-bf-black hover:text-bf-primary transition-colors duration-200">
        {phone}
      </a>

      <!-- CTA Button -->
      <Button text={t('nav.getConsultation')} href={`${langPrefix}/#contact`} size="md" />
    </div>

    <!-- Mobile Menu Button -->
    <button class="lg:hidden flex flex-col gap-1.5 p-2 -mr-2" aria-label="Open menu" id="mobile-menu-btn">
      <span class="w-6 h-0.5 bg-bf-black transition-all duration-300 origin-center" id="line1"></span>
      <span class="w-6 h-0.5 bg-bf-black transition-all duration-300" id="line2"></span>
      <span class="w-4 h-0.5 bg-bf-black transition-all duration-300 origin-center" id="line3"></span>
    </button>
  </div>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class="lg:hidden fixed inset-0 top-header bg-white z-[199] transform translate-x-full transition-transform duration-300 ease-out">
    <nav class="container-bf py-8 flex flex-col gap-6">
      {navItems.map((item, index) => (
        <a
          href={item.href}
          class:list={[
            'text-2xl font-medium transition-all duration-300 opacity-0 translate-y-4',
            item.active ? 'text-bf-primary' : 'text-bf-black',
          ]}
          style={`animation-delay: ${index * 50}ms`}
          data-mobile-link
        >
          {item.label}
        </a>
      ))}

      <!-- Mobile Language Switcher -->
      <div class="pt-6 border-t border-bf-gray-light mt-4 flex gap-4">
        {languages.map((language) => (
          <a
            href={language.code === 'uz' ? pathWithoutLang : `/${language.code}${pathWithoutLang}`}
            class:list={[
              'flex items-center gap-2 px-3 py-2 rounded-lg transition-colors',
              language.code === lang ? 'bg-bf-primary text-white' : 'bg-bf-beige text-bf-black'
            ]}
          >
            <span set:html={language.flag} />
            <span class="text-sm font-medium">{language.name}</span>
          </a>
        ))}
      </div>

      <div class="pt-4">
        <a href={`tel:${phone.replace(/\s/g, '')}`} class="text-lg font-medium text-bf-gray hover:text-bf-primary transition-colors">
          {phone}
        </a>
      </div>

      <Button text={t('nav.getConsultation')} href={`${langPrefix}/#contact`} size="lg" class="mt-4 w-fit" />
    </nav>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class="h-header"></div>


<script>
  const menuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const line1 = document.getElementById('line1');
  const line2 = document.getElementById('line2');
  const line3 = document.getElementById('line3');
  const mobileLinks = document.querySelectorAll('[data-mobile-link]');

  let isOpen = false;

  menuBtn?.addEventListener('click', () => {
    isOpen = !isOpen;
    if (isOpen) {
      mobileMenu?.classList.remove('translate-x-full');
      document.body.style.overflow = 'hidden';
      line1?.classList.add('rotate-45', 'translate-y-2');
      line2?.classList.add('opacity-0');
      line3?.classList.add('-rotate-45', '-translate-y-2', 'w-6');
      mobileLinks.forEach((link, i) => {
        setTimeout(() => {
          link.classList.remove('opacity-0', 'translate-y-4');
          link.classList.add('opacity-100', 'translate-y-0');
        }, 100 + i * 50);
      });
    } else {
      mobileMenu?.classList.add('translate-x-full');
      document.body.style.overflow = '';
      line1?.classList.remove('rotate-45', 'translate-y-2');
      line2?.classList.remove('opacity-0');
      line3?.classList.remove('-rotate-45', '-translate-y-2', 'w-6');
      mobileLinks.forEach(link => {
        link.classList.add('opacity-0', 'translate-y-4');
        link.classList.remove('opacity-100', 'translate-y-0');
      });
    }
  });

  mobileLinks.forEach(link => {
    link.addEventListener('click', () => {
      menuBtn?.click();
    });
  });

  // Language Switcher Dropdown
  const langBtn = document.getElementById('lang-btn');
  const langDropdown = document.getElementById('lang-dropdown');
  const langChevron = document.getElementById('lang-chevron');

  let langOpen = false;

  langBtn?.addEventListener('click', () => {
    langOpen = !langOpen;
    if (langOpen) {
      langDropdown?.classList.add('open');
      langChevron?.classList.add('rotate-180');
    } else {
      langDropdown?.classList.remove('open');
      langChevron?.classList.remove('rotate-180');
    }
  });

  document.addEventListener('click', (e) => {
    if (!langBtn?.contains(e.target as Node) && !langDropdown?.contains(e.target as Node)) {
      langOpen = false;
      langDropdown?.classList.remove('open');
      langChevron?.classList.remove('rotate-180');
    }
  });
</script>

<style>
  header.scrolled {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .lang-btn {
    background: none;
    border: none;
    padding: 0;
  }

  .lang-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.5rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid #f0f0f0;
    padding: 0.5rem 0;
    min-width: 120px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
  }

  .lang-dropdown.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .lang-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.5rem 1rem;
    background: none;
    border: none;
    cursor: pointer;
    font-family: 'Urbanist', sans-serif;
    font-size: 0.875rem;
    font-weight: 500;
    color: #000;
    text-decoration: none;
    transition: background 0.2s ease;
  }

  .lang-option:hover {
    background: #f5f5f5;
  }

  .lang-option.active {
    background: #f0f7ff;
    color: var(--color-primary, #13499F);
  }

  #lang-chevron {
    transition: transform 0.2s ease;
  }

  #lang-chevron.rotate-180 {
    transform: rotate(180deg);
  }
</style>
